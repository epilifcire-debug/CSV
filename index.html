<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>An치lise Inteligente de Cancelamentos</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
* { box-sizing: border-box; }
body { font-family: Arial; background:#eef1f4; margin:0; }
.container {
  max-width:1400px;
  margin:30px auto;
  background:#fff;
  padding:25px;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.1);
}
h1, h3 { text-align:center; margin-top:0; }

textarea {
  width:100%;
  height:160px;
  font-family:monospace;
  padding:10px;
}

button {
  padding:10px 18px;
  border:none;
  border-radius:6px;
  background:#3498db;
  color:#fff;
  cursor:pointer;
}
button:hover { background:#2980b9; }

.actions {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
  margin:15px 0;
}

.painel {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:10px;
  margin-bottom:25px;
}

.card {
  background:#2c3e50;
  color:#fff;
  padding:12px;
  border-radius:6px;
  text-align:center;
}
.card span {
  display:block;
  font-size:20px;
  font-weight:bold;
}
.card small { opacity:.9; }

.card.total { background:#27ae60; }
.card.geral { background:#8e44ad; }
</style>
</head>

<body>
<div class="container">

<h1>游늵 An치lise Inteligente de Cancelamentos</h1>

<h3>Resumo por Valor</h3>
<div id="painelValor" class="painel"></div>

<h3>Resumo Geral</h3>
<div id="painelGeral" class="painel"></div>

<h3>Cancelamentos por Data da Compra</h3>
<div id="painelDataCompra" class="painel"></div>

<input type="file" id="arquivo"><br><br>
<textarea id="input" placeholder="Cole os dados aqui..."></textarea>

<div class="actions">
  <button onclick="processar()">Processar</button>
  <button onclick="baixarExcel()">Baixar Excel</button>
  <button onclick="baixarCSVDetalhado()">Baixar CSV (Auditoria)</button>
</div>

</div>

<script>
let dadosExcel = [];
let resumoExcel = [];
let csvDetalhado = [];

document.getElementById("arquivo").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => document.getElementById("input").value = ev.target.result;
  reader.readAsText(file);
});

function detectarSeparador(linha){
  if (linha.includes("\t")) return "\t";
  if (linha.includes(";")) return ";";
  return ",";
}

function normalizarValor(v){
  return v.replace("R$","").replace(/\./g,"").replace(",",".").trim();
}

function moeda(v){
  return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

/**
 * Fun칞칚o inteligente:
 * - Remove caracteres n칚o num칠ricos
 * - Detecta onde come칞a uma data v치lida YYYYMMDD
 * - Ignora tudo antes da data
 */
function extrairInfoDoCodigo(codigoOriginal){
  if (!codigoOriginal) {
    return { data:"Data inv치lida", codigoTratado:"" };
  }

  const codigo = codigoOriginal.replace(/\D/g,"");

  for (let i = 0; i <= codigo.length - 8; i++) {
    const ano = parseInt(codigo.substr(i,4));
    const mes = parseInt(codigo.substr(i+4,2));
    const dia = parseInt(codigo.substr(i+6,2));

    if (
      ano >= 2000 && ano <= 2099 &&
      mes >= 1 && mes <= 12 &&
      dia >= 1 && dia <= 31
    ) {
      return {
        data: `${String(dia).padStart(2,"0")}/${String(mes).padStart(2,"0")}/${ano}`,
        codigoTratado: codigo.substring(i)
      };
    }
  }

  return {
    data: "Data n칚o identificada",
    codigoTratado: codigo
  };
}

function processar(){
  const texto = document.getElementById("input").value.trim();
  if (!texto) return alert("Informe os dados.");

  const linhas = texto.split(/\r?\n/);
  const sep = detectarSeparador(linhas[0]);
  const cab = linhas[0].split(sep);
  const ncol = cab.length;

  dadosExcel = [cab];
  resumoExcel = [["Valor","Quantidade","Total"]];
  csvDetalhado = [["Data_Compra","Codigo_Original","Codigo_Tratado","Valor"]];

  const qtdValor = {}, somaValor = {};
  const qtdData = {}, somaData = {};
  let totalQtd = 0, totalFinanceiro = 0;

  linhas.slice(1).forEach(linha=>{
    if (!linha.trim()) return;

    let cols = linha.split(sep);
    while (cols.length < ncol) cols.push("");

    const codigoOriginal =
      cols[cab.indexOf("Registro")] ||
      cols[cab.indexOf("C칩d. Barras")] ||
      "";

    const valor = parseFloat(normalizarValor(cols[ncol-1]));
    if (!valor || valor === 0 || isNaN(valor)) return;

    const info = extrairInfoDoCodigo(codigoOriginal);

    cols[ncol-1] = valor;
    dadosExcel.push(cols);

    csvDetalhado.push([
      info.data,
      codigoOriginal,
      info.codigoTratado,
      valor
    ]);

    qtdValor[valor] = (qtdValor[valor] || 0) + 1;
    somaValor[valor] = (somaValor[valor] || 0) + valor;

    qtdData[info.data] = (qtdData[info.data] || 0) + 1;
    somaData[info.data] = (somaData[info.data] || 0) + valor;

    totalQtd++;
    totalFinanceiro += valor;
  });

  const pValor = document.getElementById("painelValor");
  const pGeral = document.getElementById("painelGeral");
  const pData  = document.getElementById("painelDataCompra");

  pValor.innerHTML = pGeral.innerHTML = pData.innerHTML = "";

  Object.keys(qtdValor).sort((a,b)=>a-b).forEach(v=>{
    resumoExcel.push([v,qtdValor[v],somaValor[v]]);
    pValor.innerHTML += `
      <div class="card">
        Valor ${v}
        <span>${qtdValor[v]}</span>
        <small>${moeda(somaValor[v])}</small>
      </div>`;
  });

  resumoExcel.push(["TOTAL", totalQtd, totalFinanceiro]);

  pGeral.innerHTML = `
    <div class="card geral">Registros<span>${totalQtd}</span></div>
    <div class="card total">Total Financeiro<span>${moeda(totalFinanceiro)}</span></div>
    <div class="card geral">Valores Distintos<span>${Object.keys(qtdValor).length}</span></div>
  `;

  Object.keys(qtdData).sort((a,b)=>{
    const [da,ma,ya] = a.split("/");
    const [db,mb,yb] = b.split("/");
    return new Date(ya,ma-1,da) - new Date(yb,mb-1,db);
  }).forEach(d=>{
    pData.innerHTML += `
      <div class="card">
        ${d}
        <span>${qtdData[d]}</span>
        <small>${moeda(somaData[d])}</small>
      </div>`;
  });
}

function baixarExcel(){
  if (!dadosExcel.length) return alert("Nada processado.");
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(dadosExcel), "Dados");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(resumoExcel), "Resumo");
  XLSX.writeFile(wb, "analise_cancelamentos.xlsx");
}

function baixarCSVDetalhado(){
  if (!csvDetalhado.length) return alert("Nada processado.");
  const csv = csvDetalhado.map(l=>l.join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "cancelamentos_auditoria.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
