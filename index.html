<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard de Cancelamentos</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --bg: #0f172a;
  --card: #1e293b;
  --accent: #22c55e;
  --accent2: #38bdf8;
  --text: #e5e7eb;
  --muted: #94a3b8;
  --border: #334155;
}

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

.container {
  max-width: 1500px;
  margin: 20px auto;
  padding: 24px;
}

h1 {
  text-align: center;
  margin-bottom: 10px;
}

textarea {
  width: 100%;
  height: 180px;
  background: #020617;
  color: var(--text);
  border: 1px solid var(--border);
  padding: 10px;
  border-radius: 6px;
  font-family: monospace;
}

input[type="file"] {
  color: var(--text);
}

button {
  background: #2563eb;
  color: #fff;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
}
button:hover { background:#1d4ed8; }

.actions {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 10px;
}

.kpis {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 12px;
  margin: 20px 0;
}

.kpi {
  background: var(--card);
  border-radius: 8px;
  padding: 18px;
  text-align: center;
  box-shadow: 0 0 0 1px var(--border);
}

.kpi span {
  display: block;
  font-size: 28px;
  font-weight: bold;
  color: var(--accent);
}

.graficos {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(420px,1fr));
  gap: 20px;
}

.chart-box {
  background: var(--card);
  border-radius: 8px;
  padding: 14px;
  box-shadow: 0 0 0 1px var(--border);
}
</style>
</head>

<body>
<div class="container">

<h1>üìä Dashboard de Cancelamentos</h1>

<div class="kpis">
  <div class="kpi">Itens Cancelados<span id="kpiItens">0</span></div>
  <div class="kpi">Total Perdido<span id="kpiValor">R$ 0,00</span></div>
  <div class="kpi">Lotes Afetados<span id="kpiLotes">0</span></div>
</div>

<div class="graficos">
  <div class="chart-box"><canvas id="graficoQtdLote"></canvas></div>
  <div class="chart-box"><canvas id="graficoValorLote"></canvas></div>
  <div class="chart-box"><canvas id="graficoValor"></canvas></div>
  <div class="chart-box"><canvas id="graficoData"></canvas></div>
</div>

<br>

<input type="file" id="arquivo"><br><br>
<textarea id="input" placeholder="Cole a base aqui..."></textarea>

<div class="actions">
  <button onclick="processar()">Processar</button>
  <button onclick="baixarCSV()">CSV</button>
  <button onclick="baixarExcel()">Excel</button>
</div>

</div>

<script>
/* ================= VARI√ÅVEIS ================= */
let csvFinal=[];
let totalItens=0, totalFinanceiro=0;
let qtdPorLote={}, valorPorLote={}, qtdPorValor={}, qtdPorData={};
let charts=[];

/* ================= UTIL ================= */
function formatarMoeda(v){
  return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
function detectarSeparador(l){
  if(l.includes("\t")) return "\t";
  if(l.includes(";")) return ";";
  return ",";
}
function normalizarValor(v){
  return v.replace("R$","").replace(/\./g,"").replace(",",".").trim();
}
function extrairDataCompra(c){
  const n=c.replace(/\D/g,"");
  for(let i=0;i<=n.length-8;i++){
    const a=+n.substr(i,4),m=+n.substr(i+4,2),d=+n.substr(i+6,2);
    if(a>=2000&&a<=2099&&m>=1&&m<=12&&d>=1&&d<=31)
      return `${a}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
  }
  return "Indefinida";
}

/* ================= UPLOAD ================= */
document.getElementById("arquivo").addEventListener("change",e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=ev=>document.getElementById("input").value=ev.target.result;
  r.readAsText(f);
});

/* ================= PROCESSAR ================= */
function processar(){
  const texto=document.getElementById("input").value.trim();
  if(!texto) return alert("Informe os dados");

  const linhas=texto.split(/\r?\n/);
  const sep=detectarSeparador(linhas[0]);

  csvFinal=[["Data_Compra","Codigo","Lote","Valor"]];
  totalItens=0; totalFinanceiro=0;
  qtdPorLote={}; valorPorLote={}; qtdPorValor={}; qtdPorData={};

  linhas.forEach(l=>{
    if(!l.trim()) return;
    const c=l.split(sep);

    let valor=null;
    for(let i=c.length-1;i>=0;i--){
      const v=normalizarValor(c[i]);
      if(/^\d+(\.\d{1,2})?$/.test(v)){ valor=parseFloat(v); break; }
    }
    if(!valor || valor===0) return;

    let codigo="";
    c.forEach(x=>{
      const n=x.replace(/\D/g,"");
      if(n.length>codigo.length) codigo=n;
    });

    let lote="";
    c.forEach(x=>{ if(/lote/i.test(x)) lote=x.trim(); });

    const data=extrairDataCompra(codigo);

    csvFinal.push([data,codigo,lote,valor]);

    qtdPorLote[lote]=(qtdPorLote[lote]||0)+1;
    valorPorLote[lote]=(valorPorLote[lote]||0)+valor;
    qtdPorValor[valor]=(qtdPorValor[valor]||0)+1;
    qtdPorData[data]=(qtdPorData[data]||0)+1;

    totalItens++;
    totalFinanceiro+=valor;
  });

  atualizarDashboard();
}

/* ================= DASHBOARD ================= */
function atualizarDashboard(){
  document.getElementById("kpiItens").innerText=totalItens;
  document.getElementById("kpiValor").innerText=formatarMoeda(totalFinanceiro);
  document.getElementById("kpiLotes").innerText=Object.keys(qtdPorLote).length;

  charts.forEach(c=>c.destroy()); charts=[];

  charts.push(new Chart(graficoQtdLote,{
    type:"bar",
    data:{labels:Object.keys(qtdPorLote),datasets:[{data:Object.values(qtdPorLote),backgroundColor:"#38bdf8"}]},
    options:{plugins:{legend:{display:false}}}
  }));

  charts.push(new Chart(graficoValorLote,{
    type:"bar",
    data:{labels:Object.keys(valorPorLote),datasets:[{data:Object.values(valorPorLote),backgroundColor:"#22c55e"}]},
    options:{plugins:{legend:{display:false}}}
  }));

  charts.push(new Chart(graficoValor,{
    type:"pie",
    data:{labels:Object.keys(qtdPorValor),datasets:[{data:Object.values(qtdPorValor)}]}
  }));

  charts.push(new Chart(graficoData,{
    type:"line",
    data:{labels:Object.keys(qtdPorData),datasets:[{data:Object.values(qtdPorData),borderColor:"#facc15"}]}
  }));
}

/* ================= EXPORT ================= */
function baixarCSV(){
  const csv=csvFinal.map(l=>l.join(",")).join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="cancelamentos.csv";
  a.click();
}

function baixarExcel(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(csvFinal);
  XLSX.utils.book_append_sheet(wb,ws,"Dados");
  XLSX.writeFile(wb,"dashboard_cancelamentos.xlsx");
}
</script>

</body>
</html>
