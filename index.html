<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Separador DinÃ¢mico por Valor</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  padding: 20px;
}
h1 {
  color: #2c3e50;
}
textarea {
  width: 100%;
  height: 220px;
  padding: 10px;
  font-family: monospace;
}
button {
  margin-top: 10px;
  padding: 10px 16px;
  font-size: 16px;
  cursor: pointer;
}
pre {
  background: #fff;
  padding: 15px;
  border: 1px solid #ccc;
  white-space: pre-wrap;
}
</style>
</head>
<body>

<h1>ðŸ“Š Separador AutomÃ¡tico de Cancelamentos</h1>

<p>Cole os dados abaixo:</p>
<textarea id="input"></textarea>

<br>
<button onclick="processar()">Processar</button>
<button onclick="baixar()">Baixar CSV</button>

<h2>Resultado</h2>
<pre id="output"></pre>

<script>
let resultadoFinal = "";

function normalizarValor(valor) {
  return valor.replace("R$", "").replace(".", "").replace(",", ".").trim();
}

function processar() {
  const texto = document.getElementById("input").value.trim();
  if (!texto) return alert("Cole os dados primeiro");

  const linhas = texto.split("\n");
  const cabecalho = linhas[0];
  const dados = linhas.slice(1);

  const grupos = {};
  let totalGeral = 0;

  dados.forEach(linha => {
    const colunas = linha.split("\t");
    const valorBruto = colunas[colunas.length - 1];
    if (!valorBruto) return;

    const valor = normalizarValor(valorBruto);

    if (!grupos[valor]) grupos[valor] = [];
    grupos[valor].push(colunas.slice(0, -1).join(",") + "," + valor);

    totalGeral++;
  });

  resultadoFinal = cabecalho.replace(/\t/g, ",") + "\n";

  Object.keys(grupos)
    .sort((a, b) => parseFloat(a) - parseFloat(b))
    .forEach(valor => {
      resultadoFinal += `### INICIO_VALOR_${valor}\n`;
      grupos[valor].forEach(l => resultadoFinal += l + "\n");
      resultadoFinal += `### TOTAL_VALOR_${valor},,,,,,,${grupos[valor].length}\n`;
    });

  resultadoFinal += `### TOTAL_GERAL,,,,,,,${totalGeral}`;

  document.getElementById("output").textContent = resultadoFinal;
}

function baixar() {
  if (!resultadoFinal) return alert("Nenhum dado processado");

  const blob = new Blob([resultadoFinal], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "cancelamentos_separados.csv";
  a.click();

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
