<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>AnÃ¡lise de Cancelamentos</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
}
.container {
  max-width: 1300px;
  margin: 30px auto;
  background: #fff;
  padding: 25px;
  border-radius: 8px;
}
h1, h3 {
  text-align: center;
  margin-top: 0;
}
textarea {
  width: 100%;
  height: 220px;
  font-family: monospace;
  padding: 10px;
}
button {
  padding: 10px 16px;
  border: none;
  background: #007bff;
  color: white;
  border-radius: 4px;
  cursor: pointer;
}
button:hover {
  background: #0056b3;
}
.actions {
  margin-top: 15px;
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}
.painel {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 10px;
  margin: 20px 0;
}
.card {
  background: #2c3e50;
  color: white;
  padding: 14px;
  border-radius: 6px;
  text-align: center;
}
.card span {
  display: block;
  font-size: 20px;
  font-weight: bold;
}
.card.total {
  background: #27ae60;
}
</style>
</head>

<body>
<div class="container">

<h1>ðŸ“Š AnÃ¡lise de Cancelamentos</h1>

<h3>Cancelamentos por Lote e Valor</h3>
<div id="painelLoteValor" class="painel"></div>

<h3>Impacto Financeiro dos Cancelamentos</h3>
<div id="painelFinanceiro" class="painel"></div>

<input type="file" id="arquivo"><br><br>
<textarea id="input" placeholder="Cole a base aqui..."></textarea>

<div class="actions">
  <button onclick="processar()">Processar</button>
  <button onclick="baixarCSV()">Baixar CSV</button>
  <button onclick="baixarExcel()">Baixar Excel (.XLSX)</button>
</div>

</div>

<script>
/* ================= UTILIDADES ================= */

function formatarMoeda(valor) {
  return valor.toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL",
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function detectarSeparador(l) {
  if (l.includes("\t")) return "\t";
  if (l.includes(";")) return ";";
  return ",";
}

function normalizarValor(v) {
  return v.replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
}

function extrairDataCompra(codigo) {
  if (!codigo) return "";
  const limpo = codigo.replace(/\D/g, "");
  for (let i = 0; i <= limpo.length - 8; i++) {
    const ano = +limpo.substr(i, 4);
    const mes = +limpo.substr(i + 4, 2);
    const dia = +limpo.substr(i + 6, 2);
    if (ano >= 2000 && ano <= 2099 && mes >= 1 && mes <= 12 && dia >= 1 && dia <= 31) {
      return `${String(dia).padStart(2,"0")}/${String(mes).padStart(2,"0")}/${ano}`;
    }
  }
  return "";
}

/* ================= VARIÃVEIS ================= */

let csvFinal = [];
let resumoLoteValor = {};
let totalFinanceiro = 0;
let totalItens = 0;

/* ================= UPLOAD ================= */

document.getElementById("arquivo").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = ev => document.getElementById("input").value = ev.target.result;
  r.readAsText(file);
});

/* ================= PROCESSAR ================= */

function processar() {
  const texto = document.getElementById("input").value.trim();
  if (!texto) return alert("Informe os dados.");

  const linhas = texto.split(/\r?\n/);
  const sep = detectarSeparador(linhas[0]);

  csvFinal = [["Data_Compra","Data_Cancelamento","Codigo_Original","Lote","Valor"]];
  resumoLoteValor = {};
  totalFinanceiro = 0;
  totalItens = 0;

  linhas.forEach(linha => {
    if (!linha.trim()) return;
    const cols = linha.split(sep);

    let valor = null;
    for (let i = cols.length - 1; i >= 0; i--) {
      const v = normalizarValor(cols[i]);
      if (/^\d+(\.\d{1,2})?$/.test(v)) {
        valor = parseFloat(v);
        break;
      }
    }
    if (!valor || isNaN(valor) || valor === 0) return;

    let codigo = "";
    cols.forEach(c => {
      const num = c.replace(/\D/g, "");
      if (num.length >= 8 && num.length > codigo.length) codigo = num;
    });

    let lote = "";
    cols.forEach(c => {
      if (/lote/i.test(c)) lote = c.trim();
    });

    const dataCompra = extrairDataCompra(codigo);
    let dataCancel = "";
    cols.forEach(c => {
      if (/\d{2}\/\d{2}\/\d{4}/.test(c)) dataCancel = c.substring(0,10);
    });

    csvFinal.push([dataCompra, dataCancel, codigo, lote, valor]);

    const chave = `${lote} | ${formatarMoeda(valor)}`;
    resumoLoteValor[chave] = (resumoLoteValor[chave] || 0) + 1;

    totalFinanceiro += valor;
    totalItens++;
  });

  montarPainel();
}

/* ================= PAINÃ‰IS ================= */

function montarPainel() {
  const painel = document.getElementById("painelLoteValor");
  painel.innerHTML = "";
  Object.keys(resumoLoteValor).forEach(k => {
    painel.innerHTML += `
      <div class="card">
        ${k}
        <span>${resumoLoteValor[k]} cancelamentos</span>
      </div>`;
  });

  document.getElementById("painelFinanceiro").innerHTML = `
    <div class="card total">
      Itens cancelados
      <span>${totalItens}</span>
    </div>
    <div class="card total">
      Total financeiro perdido
      <span>${formatarMoeda(totalFinanceiro)}</span>
    </div>`;
}

/* ================= CSV ================= */

function baixarCSV() {
  if (csvFinal.length <= 1) return alert("Nada processado.");
  const csv = csvFinal.map(l => l.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "cancelamentos_analise.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* ================= EXCEL ================= */

function baixarExcel() {
  if (csvFinal.length <= 1) return alert("Nada processado.");

  const dados = [...csvFinal];
  dados.push(["","","","TOTAL",{ f:`SUM(E2:E${dados.length})` }]);

  const dadosSheet = XLSX.utils.aoa_to_sheet(dados);
  const rangeDados = XLSX.utils.decode_range(dadosSheet["!ref"]);
  for (let r = 1; r <= rangeDados.e.r; r++) {
    const cell = XLSX.utils.encode_cell({ r, c: 4 });
    if (dadosSheet[cell]) dadosSheet[cell].z = '"R$" #,##0.00';
  }

  const resumo = [["Lote","Quantidade","Valor UnitÃ¡rio","Total Financeiro"]];
  const controle = {};

  Object.keys(resumoLoteValor).forEach(k => {
    const [lote, valorTxt] = k.split(" | ");
    const valor = parseFloat(valorTxt.replace("R$","").replace(".","").replace(",","."));
    if (!controle[lote]) controle[lote] = { qtd:0, valor };
    controle[lote].qtd += resumoLoteValor[k];
  });

  Object.keys(controle).forEach(lote => {
    resumo.push([lote, controle[lote].qtd, controle[lote].valor, controle[lote].qtd * controle[lote].valor]);
  });

  const resumoSheet = XLSX.utils.aoa_to_sheet(resumo);
  const rangeResumo = XLSX.utils.decode_range(resumoSheet["!ref"]);
  for (let r = 1; r <= rangeResumo.e.r; r++) {
    ["C","D"].forEach(col => {
      const cell = col + (r + 1);
      if (resumoSheet[cell]) resumoSheet[cell].z = '"R$" #,##0.00';
    });
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, dadosSheet, "Dados");
  XLSX.utils.book_append_sheet(wb, resumoSheet, "Resumo");
  XLSX.writeFile(wb, "cancelamentos_dashboard.xlsx");
}
</script>

</body>
</html>
