<script>
let tabelaExcel = {};
let resumoExcel = [];

document.getElementById("arquivo").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = ev => document.getElementById("input").value = ev.target.result;
  r.readAsText(file);
});

function detectarSeparador(l){
  if(l.includes("\t")) return "\t";
  if(l.includes(";")) return ";";
  return ",";
}

function normalizarValor(v){
  return v.replace("R$","").replace(/\./g,"").replace(",",".").trim();
}

function processar(){
  const texto = document.getElementById("input").value.trim();
  if(!texto) return alert("Informe dados.");

  const linhas = texto.split(/\r?\n/);
  const sep = detectarSeparador(linhas[0]);
  const cab = linhas[0].split(sep);
  const ncol = cab.length;

  tabelaExcel = {};
  resumoExcel = [];
  let totalGeral = 0;

  linhas.slice(1).forEach(l=>{
    if(!l.trim()) return;
    let cols = l.split(sep);
    while(cols.length < ncol) cols.push("");

    const valor = normalizarValor(cols[ncol-1]);
    if(!valor || parseFloat(valor) === 0 || isNaN(valor)) return;

    if(!tabelaExcel[valor]) tabelaExcel[valor] = [cab];
    tabelaExcel[valor].push(cols.slice(0,ncol-1).concat(valor));

    totalGeral++;
  });

  resumoExcel.push(["Valor", "Quantidade"]);
  Object.keys(tabelaExcel).sort((a,b)=>a-b).forEach(v=>{
    resumoExcel.push([v, tabelaExcel[v].length - 1]);
  });
  resumoExcel.push(["TOTAL GERAL", totalGeral]);

  montarPainelVisual();
}

function montarPainelVisual(){
  const painel = document.getElementById("painelResumo");
  const blocos = document.getElementById("blocos");
  painel.innerHTML = "";
  blocos.innerHTML = "";

  Object.keys(tabelaExcel).sort((a,b)=>a-b).forEach(v=>{
    painel.innerHTML += `
      <div class="cardResumo">Valor ${v}<span>${tabelaExcel[v].length - 1}</span></div>
    `;

    const bloco = document.createElement("div");
    bloco.className = "bloco";
    bloco.innerHTML = `
      <h3>Valor ${v}</h3>
      <pre>${tabelaExcel[v].slice(1).map(l=>l.join(" | ")).join("\n")}</pre>
      <div class="total">Total: ${tabelaExcel[v].length - 1}</div>
    `;
    blocos.appendChild(bloco);
  });

  painel.innerHTML += `
    <div class="cardResumo" style="background:#27ae60">
      TOTAL GERAL<span>${resumoExcel[resumoExcel.length-1][1]}</span>
    </div>
  `;
}

function baixarExcel(){
  if(Object.keys(tabelaExcel).length === 0) {
    alert("Nada processado.");
    return;
  }

  const wb = XLSX.utils.book_new();

  // Aba Resumo
  const wsResumo = XLSX.utils.aoa_to_sheet(resumoExcel);
  XLSX.utils.book_append_sheet(wb, wsResumo, "Resumo");

  // Abas por valor
  Object.keys(tabelaExcel).sort((a,b)=>a-b).forEach(v=>{
    const ws = XLSX.utils.aoa_to_sheet(tabelaExcel[v]);
    XLSX.utils.book_append_sheet(wb, ws, `Valor_${v}`);
  });

  XLSX.writeFile(wb, "relatorio_cancelamentos.xlsx");
}
</script>
