<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>AnÃ¡lise de Cancelamentos - Base Unificada</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
}
.container {
  max-width: 1200px;
  margin: 30px auto;
  background: #fff;
  padding: 25px;
  border-radius: 8px;
}
h1 {
  text-align: center;
}
textarea {
  width: 100%;
  height: 220px;
  font-family: monospace;
  padding: 10px;
}
button {
  padding: 10px 16px;
  border: none;
  background: #007bff;
  color: white;
  border-radius: 4px;
  cursor: pointer;
}
button:hover {
  background: #0056b3;
}
.actions {
  margin-top: 15px;
  display: flex;
  gap: 10px;
  justify-content: center;
}
</style>
</head>

<body>
<div class="container">
<h1>ðŸ“Š AnÃ¡lise de Cancelamentos (Formato Unificado)</h1>

<input type="file" id="arquivo"><br><br>
<textarea id="input" placeholder="Cole a base aqui..."></textarea>

<div class="actions">
  <button onclick="processar()">Processar</button>
  <button onclick="baixarCSV()">Baixar CSV (AnÃ¡lise)</button>
</div>
</div>

<script>
let csvFinal = [];

document.getElementById("arquivo").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = ev => document.getElementById("input").value = ev.target.result;
  r.readAsText(file);
});

function detectarSeparador(l) {
  if (l.includes("\t")) return "\t";
  if (l.includes(";")) return ";";
  return ",";
}

function normalizarValor(v) {
  return v.replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
}

/* ðŸ”Ž Detecta onde comeÃ§a a data YYYYMMDD dentro do cÃ³digo */
function extrairDataCompra(codigo) {
  if (!codigo) return "";
  const limpo = codigo.replace(/\D/g, "");
  for (let i = 0; i <= limpo.length - 8; i++) {
    const ano = parseInt(limpo.substr(i, 4));
    const mes = parseInt(limpo.substr(i + 4, 2));
    const dia = parseInt(limpo.substr(i + 6, 2));
    if (
      ano >= 2000 && ano <= 2099 &&
      mes >= 1 && mes <= 12 &&
      dia >= 1 && dia <= 31
    ) {
      return `${String(dia).padStart(2,"0")}/${String(mes).padStart(2,"0")}/${ano}`;
    }
  }
  return "";
}

function processar() {
  const texto = document.getElementById("input").value.trim();
  if (!texto) return alert("Informe os dados.");

  const linhas = texto.split(/\r?\n/);
  const sep = detectarSeparador(linhas[0]);

  csvFinal = [
    ["Data_Compra", "Data_Cancelamento", "Codigo_Original", "Lote", "Valor"]
  ];

  linhas.forEach(linha => {
    if (!linha.trim()) return;

    const cols = linha.split(sep);

    // ðŸ”¹ Valor: procura da direita para esquerda
    let valor = null;
    for (let i = cols.length - 1; i >= 0; i--) {
      const v = normalizarValor(cols[i]);
      if (/^\d+(\.\d{1,2})?$/.test(v)) {
        valor = parseFloat(v);
        break;
      }
    }
    if (!valor || valor === 0) return;

    // ðŸ”¹ CÃ³digo: maior sequÃªncia numÃ©rica da linha
    let codigo = "";
    cols.forEach(c => {
      const num = c.replace(/\D/g, "");
      if (num.length >= 8 && num.length > codigo.length) {
        codigo = num;
      }
    });

    // ðŸ”¹ Data da compra
    const dataCompra = extrairDataCompra(codigo);

    // ðŸ”¹ Data do cancelamento (se existir)
    let dataCancel = "";
    cols.forEach(c => {
      if (/\d{2}\/\d{2}\/\d{4}/.test(c)) {
        dataCancel = c.substring(0,10);
      }
    });

    // ðŸ”¹ Lote (texto que contÃ©m "Lote")
    let lote = "";
    cols.forEach(c => {
      if (/lote/i.test(c)) {
        lote = c.trim();
      }
    });

    csvFinal.push([
      dataCompra,
      dataCancel,
      codigo,
      lote,
      valor
    ]);
  });

  alert("Processamento concluÃ­do com sucesso.");
}

function baixarCSV() {
  if (csvFinal.length <= 1) return alert("Nada processado.");

  const csv = csvFinal.map(l => l.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "cancelamentos_analise_completa.csv";
  a.click();

  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
