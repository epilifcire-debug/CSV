<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>An치lise de Cancelamentos</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
* { box-sizing: border-box; }
body { font-family: Arial; background:#eef1f4; margin:0; }
.container {
  max-width:1300px; margin:30px auto; background:#fff;
  padding:25px; border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.1);
}
h1, h3 { margin-top:0; text-align:center; }

textarea { width:100%; height:160px; font-family:monospace; padding:10px; }

button {
  padding:10px 18px; border:none; border-radius:6px;
  background:#3498db; color:white; cursor:pointer;
}
button:hover { background:#2980b9; }

.actions {
  display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
  margin:15px 0;
}

.painel {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:10px;
  margin-bottom:20px;
}

.card {
  background:#2c3e50; color:white;
  padding:12px; border-radius:6px;
  text-align:center;
}
.card span {
  display:block;
  font-size:20px;
  font-weight:bold;
}
.card small { opacity:.9; }

.card.total { background:#27ae60; }
.card.geral { background:#8e44ad; }
</style>
</head>

<body>
<div class="container">

<h1>游늵 An치lise Completa de Cancelamentos</h1>

<h3>Resumo por Valor</h3>
<div id="painelValor" class="painel"></div>

<h3>Resumo Geral</h3>
<div id="painelGeral" class="painel"></div>

<h3>Cancelamentos por Data da Compra</h3>
<div id="painelDataCompra" class="painel"></div>

<input type="file" id="arquivo"><br><br>
<textarea id="input" placeholder="Cole os dados aqui..."></textarea>

<div class="actions">
  <button onclick="processar()">Processar</button>
  <button onclick="baixarExcel()">Baixar Excel</button>
  <button onclick="baixarCSVDetalhado()">Baixar CSV (An치lise)</button>
</div>

</div>

<script>
let dadosExcel = [];
let resumoExcel = [];
let csvDetalhado = [];

document.getElementById("arquivo").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = ev => document.getElementById("input").value = ev.target.result;
  r.readAsText(file);
});

function detectarSeparador(l){
  if (l.includes("\t")) return "\t";
  if (l.includes(";")) return ";";
  return ",";
}

function normalizarValor(v){
  return v.replace("R$","").replace(/\./g,"").replace(",",".").trim();
}

function moeda(v){
  return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function extrairDataDoCodigo(codigo){
  if (!codigo || codigo.length < 8) return "Data inv치lida";
  const a = codigo.substring(0,4);
  const m = codigo.substring(4,6);
  const d = codigo.substring(6,8);
  return `${d}/${m}/${a}`;
}

function processar(){
  const texto = document.getElementById("input").value.trim();
  if(!texto) return alert("Informe os dados.");

  const linhas = texto.split(/\r?\n/);
  const sep = detectarSeparador(linhas[0]);
  const cab = linhas[0].split(sep);
  const ncol = cab.length;

  dadosExcel = [cab];
  resumoExcel = [["Valor","Quantidade","Total"]];
  csvDetalhado = [["Data_Compra","Codigo_Completo","Valor"]];

  const qtdValor = {}, somaValor = {};
  const qtdData = {}, somaData = {};
  let totalQtd = 0, totalFinanceiro = 0;

  linhas.slice(1).forEach(l=>{
    if(!l.trim()) return;
    let cols = l.split(sep);
    while(cols.length < ncol) cols.push("");

    const codigo =
      cols[cab.indexOf("Registro")] ||
      cols[cab.indexOf("C칩d. Barras")] ||
      "";

    const valor = parseFloat(normalizarValor(cols[ncol-1]));
    if(!valor || valor === 0 || isNaN(valor)) return;

    const dataCompra = extrairDataDoCodigo(codigo);

    cols[ncol-1] = valor;
    dadosExcel.push(cols);

    csvDetalhado.push([dataCompra, codigo, valor]);

    qtdValor[valor] = (qtdValor[valor]||0)+1;
    somaValor[valor] = (somaValor[valor]||0)+valor;

    qtdData[dataCompra] = (qtdData[dataCompra]||0)+1;
    somaData[dataCompra] = (somaData[dataCompra]||0)+valor;

    totalQtd++;
    totalFinanceiro += valor;
  });

  const pValor = document.getElementById("painelValor");
  const pGeral = document.getElementById("painelGeral");
  const pData = document.getElementById("painelDataCompra");

  pValor.innerHTML = pGeral.innerHTML = pData.innerHTML = "";

  Object.keys(qtdValor).sort((a,b)=>a-b).forEach(v=>{
    resumoExcel.push([v,qtdValor[v],somaValor[v]]);
    pValor.innerHTML += `
      <div class="card">
        Valor ${v}
        <span>${qtdValor[v]}</span>
        <small>${moeda(somaValor[v])}</small>
      </div>`;
  });

  resumoExcel.push(["TOTAL", totalQtd, totalFinanceiro]);

  pGeral.innerHTML = `
    <div class="card geral">Registros<span>${totalQtd}</span></div>
    <div class="card total">Total Financeiro<span>${moeda(totalFinanceiro)}</span></div>
    <div class="card geral">Valores Distintos<span>${Object.keys(qtdValor).length}</span></div>
  `;

  Object.keys(qtdData).sort((a,b)=>{
    const [da,ma,ya]=a.split("/");
    const [db,mb,yb]=b.split("/");
    return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);
  }).forEach(d=>{
    pData.innerHTML += `
      <div class="card">
        ${d}
        <span>${qtdData[d]}</span>
        <small>${moeda(somaData[d])}</small>
      </div>`;
  });
}

function baixarExcel(){
  if(dadosExcel.length===0) return alert("Nada processado.");
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(dadosExcel),"Dados");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(resumoExcel),"Resumo");
  XLSX.writeFile(wb,"analise_cancelamentos.xlsx");
}

function baixarCSVDetalhado(){
  if(csvDetalhado.length===0) return alert("Nada processado.");
  const csv = csvDetalhado.map(l=>l.join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="cancelamentos_por_codigo.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
